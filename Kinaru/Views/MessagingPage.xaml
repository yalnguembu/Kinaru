<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Kinaru.ViewModels"
             x:Class="Kinaru.Views.MessagingPage"
             x:DataType="vm:MessagingViewModel"
             Title="Messages"
             BackgroundColor="White">

    <Grid RowDefinitions="*,Auto">

        <!-- Conversations List View -->
        <RefreshView IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     IsVisible="{Binding IsConversationView}"
                     Grid.Row="0">
            <CollectionView ItemsSource="{Binding Conversations}">
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="8">
                        <Label Text="Aucune conversation"
                               FontSize="16"
                               TextColor="#6B7280"
                               HorizontalOptions="Center" />
                        <Label Text="Commencez à discuter avec un agent"
                               FontSize="14"
                               TextColor="#9CA3AF"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="0"
                                BackgroundColor="White"
                                Padding="16"
                                Margin="0,0,0,1">
                            <Grid ColumnDefinitions="50,*,Auto">
                                <!-- Avatar -->
                                <Border StrokeThickness="0"
                                        BackgroundColor="#E5E7EB"
                                        WidthRequest="50"
                                        HeightRequest="50"
                                        Grid.Column="0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="25" />
                                    </Border.StrokeShape>
                                    <Label Text="{Binding OtherUserName, StringFormat='{0:C1}'}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           TextColor="#1E3A5F"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Border>

                                <!-- Conversation Info -->
                                <VerticalStackLayout Grid.Column="1" Spacing="4" Padding="12,0,0,0" VerticalOptions="Center">
                                    <Label Text="{Binding OtherUserName}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="#1F2937" />
                                    <Label Text="{Binding LastMessage}"
                                           FontSize="14"
                                           TextColor="#6B7280"
                                           MaxLines="1"
                                           LineBreakMode="TailTruncation" />
                                </VerticalStackLayout>

                                <!-- Timestamp and Unread Badge -->
                                <VerticalStackLayout Grid.Column="2" Spacing="4" VerticalOptions="Center">
                                    <Label Text="{Binding LastMessageDate, StringFormat='{0:HH:mm}'}"
                                           FontSize="12"
                                           TextColor="#9CA3AF"
                                           HorizontalOptions="End" />
                                    <Border StrokeThickness="0"
                                            BackgroundColor="#FF6B35"
                                            WidthRequest="20"
                                            HeightRequest="20"
                                            HorizontalOptions="End"
                                            IsVisible="{Binding UnreadCount, Converter={StaticResource IntToBoolConverter}}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="10" />
                                        </Border.StrokeShape>
                                        <Label Text="{Binding UnreadCount}"
                                               FontSize="10"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Border>
                                </VerticalStackLayout>

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MessagingViewModel}}, Path=OpenConversationCommand}"
                                                          CommandParameter="{Binding OtherUserId}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Message Thread View -->
        <Grid RowDefinitions="Auto,*"
              IsVisible="{Binding IsConversationView, Converter={StaticResource InvertedBoolConverter}}"
              Grid.Row="0">

            <!-- Header with Back Button -->
            <Grid ColumnDefinitions="Auto,*" Padding="16" BackgroundColor="#F9FAFB" Grid.Row="0">
                <Button Text="←"
                        FontSize="24"
                        BackgroundColor="Transparent"
                        TextColor="#1E3A5F"
                        Padding="0"
                        WidthRequest="40"
                        Clicked="OnBackClicked"
                        Grid.Column="0" />
                <Label Text="{Binding OtherUserName}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="#1E3A5F"
                       VerticalOptions="Center"
                       Grid.Column="1"
                       Margin="8,0,0,0" />
            </Grid>

            <!-- Messages List -->
            <RefreshView IsRefreshing="{Binding IsRefreshing}"
                         Command="{Binding RefreshCommand}"
                         Grid.Row="1">
                <CollectionView ItemsSource="{Binding Messages}"
                                VerticalScrollBarVisibility="Always">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="16,8">
                                <Border StrokeThickness="0"
                                        BackgroundColor="{Binding IsFromCurrentUser, Converter={StaticResource BoolToColorConverter}}"
                                        Padding="12"
                                        MaximumWidthRequest="280"
                                        HorizontalOptions="{Binding IsFromCurrentUser, Converter={StaticResource BoolToLayoutOptionsConverter}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="{Binding Contenu}"
                                               FontSize="14"
                                               TextColor="{Binding IsFromCurrentUser, Converter={StaticResource BoolToTextColorConverter}}"
                                               LineBreakMode="WordWrap" />
                                        <Label Text="{Binding DateEnvoi, StringFormat='{0:HH:mm}'}"
                                               FontSize="11"
                                               TextColor="{Binding IsFromCurrentUser, Converter={StaticResource BoolToTextColorConverter}}"
                                               Opacity="0.7"
                                               HorizontalOptions="End" />
                                    </VerticalStackLayout>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>
        </Grid>

        <!-- Message Input (only visible in conversation view) -->
        <Border StrokeThickness="1"
                Stroke="#E5E7EB"
                BackgroundColor="White"
                Padding="12"
                IsVisible="{Binding IsConversationView, Converter={StaticResource InvertedBoolConverter}}"
                Grid.Row="1">
            <Border.Shadow>
                <Shadow Brush="#E5E7EB" Offset="0,-2" Radius="8" Opacity="0.3" />
            </Border.Shadow>
            <Grid ColumnDefinitions="*,Auto">
                <Border StrokeThickness="1"
                        Stroke="#E5E7EB"
                        BackgroundColor="#F9FAFB"
                        Padding="12,8"
                        Grid.Column="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20" />
                    </Border.StrokeShape>
                    <Entry Placeholder="Tapez votre message..."
                           Text="{Binding NewMessage}"
                           PlaceholderColor="#9CA3AF"
                           TextColor="#1F2937"
                           BackgroundColor="Transparent"
                           VerticalOptions="Center"
                           ReturnCommand="{Binding SendMessageCommand}" />
                </Border>
                <Button Text="Envoyer"
                        BackgroundColor="#1E3A5F"
                        TextColor="White"
                        FontSize="14"
                        FontAttributes="Bold"
                        CornerRadius="20"
                        Padding="16,8"
                        Command="{Binding SendMessageCommand}"
                        Grid.Column="1"
                        Margin="8,0,0,0" />
            </Grid>
        </Border>

        <!-- Loading Indicator -->
        <ActivityIndicator IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           Color="#FF6B35"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Grid.Row="0" />

    </Grid>
</ContentPage>
